#!/bin/bash

# --- Storage Setup ---
termux-setup-storage &>/dev/null
sleep 2
while [ ! -d ~/storage/shared ]; do
    echo -e "\e[31m[ERR] Storage permission denied\e[0m"
    sleep 2
done
clear

echo -e "\e[36m[+] Installing all required packages...\e[0m"
pkg install root-repo -y
pkg update -y
pkg upgrade -y
pkg install wget -y
pkg install git -y
pkg install hashdeep -y
pkg install x11-repo -y
pkg install termux-am -y
pkg install wget -y  # Повтор как в оригинале
pkg install root-repo -y
pkg install x11-repo -y
pkg install termux-x11-nightly -y
pkg install tur-repo -y
pkg install xwayland -y
pkg install xorg-xrandr -y
pkg install p7zip -y
pkg install patchelf -y
pkg install ncurses-utils -y
pkg install hashdeep -y
pkg install mesa-zink -y
pkg install virglrenderer-mesa-zink -y
pkg install vulkan-loader-android -y
pkg install virglrenderer-android -y
apt install android-tools -y
pkg install python-tkinter -y
pkg install xfce4 -y
apt install xfce4-whiskermenu-plugin -y
apt install xfce4-screenshooter -y
apt install xfce4-taskmanager -y
apt install xfce4-docklike-plugin -y
apt install matchbox-keyboard -y
pkg install gimp -y
pkg install mpv -y
pkg install firefox -y
pkg install vlc -y
pkg install vlc-qt -y
pkg install abiword -y
apt install ristretto -y
clear

echo -e "\e[32m[✓] All packages installed successfully.\e[0m"
sleep 2
clear

if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [[ "$i" =~ ^[Yy]$ ]]; then
        rm -rf $PREFIX/glibc
    else
        exit 1
    fi
fi

echo "Select build:"
echo "1) Box86"
echo "2) WoW64"
read -p "Selected number: " choice

case "$choice" in
1)
    echo -e "\e[36m[+] Installing BoxWine Box86 build...\e[0m"
    wget -q --show-progress -O $PREFIX/glibc.box86.tar.xz https://github.com/ShephardOS9/BoxWine/releases/download/Glibc/glibc.box86.tar.xz
    tar -xf $PREFIX/glibc.box86.tar.xz -C $PREFIX
    cp $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin
    cp $PREFIX/glibc/opt/scripts/wine $PREFIX/bin
    chmod +x $PREFIX/glibc/opt/scripts/*
    chmod 777 $PREFIX/bin/boxwine
    rm $PREFIX/glibc.box86.tar.xz
    echo -e "\e[32m[✓] BoxWine Box86 build installed.\e[0m"
    ;;
2)
    echo -e "\e[36m[+] Installing BoxWine Wow64 build...\e[0m"
    wget -q --show-progress -O $PREFIX/glibc.wow64.tar.xz https://github.com/ShephardOS9/BoxWine/releases/download/Glibc/glibc.wow64.tar.xz
    tar -xf $PREFIX/glibc.wow64.tar.xz -C $PREFIX
    cp $PREFIX/glibc/opt/scripts/boxwine $PREFIX/bin
    chmod +x $PREFIX/glibc/opt/scripts/*
    chmod 777 $PREFIX/bin/boxwine
    rm $PREFIX/glibc.wow64.tar.xz
    echo -e "\e[32m[✓] BoxWine Wow64 build installed.\e[0m"
    ;;
*)
    echo -e "\e[31mInvalid selection.\e[0m"
    exit 1
    ;;
esac

clear
echo -e "\e[32m[✓] BoxWine installation complete.\e[0m"
echo -e "\e[36m[i] Type \e[33mboxwine\e[36m to start the emulator.\e[0m"
